# =============================================================================
# LLM 시스템 프롬프트
# =============================================================================
# LLM이 사용자 입력을 키워드로 태그화할 때 사용하는 기본 지침
# 감정적 표현 제외, 구체적 키워드 중심으로 5-6개 추출
SYSTEM_PROMPT = """
[역할]
당신은 사용자의 문장에서 의미 있는 구체적 키워드를 추출하는 '태그 생성 전문가'입니다.

[태그화 규칙]
1. 사용자의 문장에서 **핵심 명사 또는 형용사**만 추출합니다.
2. **감정적·추상적 단어**(예: '좋은', '멋진', '재미있는', '예쁜', '최고')는 제외합니다.
3. **구체적인 사물, 음식, 행동, 분위기, 공간적 특징** 중심으로 태그화합니다.
4. **비유적 표현, 관용구, 강조 구절**(예: '둘이 먹다 하나 죽어도 모를 정도', '끝내준다')는 태그로 포함하지 않습니다.
5. 유사한 단어는 한 번만 포함합니다. (예: '한적한', '조용한' → 하나만)
6. 반드시 **2개 이상의 키워드**만 출력합니다.
7. 출력은 반드시 **한 줄**, **쉼표(,)로만 구분**하여 작성합니다.
8. 설명, 문장, 불릿, 숫자, 따옴표 등은 포함하지 않습니다. **키워드만 출력하세요.**

[출력 형식 예시]
올바른 출력 예시: 치즈케이크, 고구마 라떼, 한적한, 뷰, 조용한 공간
잘못된 출력 예시: 키워드는 다음과 같습니다 → 치즈케이크, 뷰, 조용한 공간 
잘못된 출력 예시: ["치즈케이크","뷰","조용한 공간"] 

[예시]
입력: "치즈케익이 맛있고, 고구마 라떼가 있었으면 좋겠어. 그리고 한적하고, 뷰가 좋았으면 좋겠어."
출력: 치즈케이크, 고구마 라떼, 한적한, 뷰, 조용한 공간

입력: "바닐라 라떼가 맛있고, 초코케익이 있었으면 좋겠어."
출력: 바닐라 라떼, 초코케이크, 디저트, 음료, 달콤한

입력: "탁 트인 뷰가 좋고, 음악이 잔잔했으면 좋겠어."
출력: 뷰, 음악, 잔잔한, 분위기, 카페, 조용한

입력: "커피 맛이 진하고 좌석이 편한 곳이 좋아."
출력: 커피, 진한 맛, 좌석, 편한, 공간, 분위기

입력: "둘이 먹다 하나 죽어도 모를 것 같은 맛있는 김치찌개랑 돼지고기 삼겹살을 먹고 싶어."
출력: 김치찌개, 삼겹살, 돼지고기, 얼큰한, 고기, 구이
"""


# =============================================================================
# 카테고리별 맞춤 프롬프트 템플릿
# =============================================================================

def _get_people_exclusion_rule(people_count: int) -> str:
    """
    인원수 관련 제외 규칙 생성

    Args:
        people_count: 인원 수

    Returns:
        인원수 관련 제외 규칙 문자열
    """
    if people_count >= 2:
        return f"- 인원 수가 {people_count}명이므로 '혼자', '1인', '솔로', '혼밥' 등 1인 관련 키워드는 제외"
    return ""


def _get_cafe_prompt(user_detail: str, people_count: int, people_exclusion_rule: str) -> str:
    """
    카페 카테고리 프롬프트 생성

    Args:
        user_detail: 사용자 입력 문장
        people_count: 인원 수
        people_exclusion_rule: 인원수 관련 제외 규칙

    Returns:
        카페 카테고리 프롬프트
    """
    return f"""
        [상황 정보]
        - 인원 수: {people_count}명
        - 활동 카테고리: 카페

        사용자가 "{user_detail}"라고 말했어.

        **부정 표현 처리 규칙:**
        - 사용자가 "~싫어", "~안돼", "~빼고", "~말고" 등 부정 표현을 사용했을 경우:
          1. 명확한 반대 개념이 있으면 반대 키워드로 변환
          2. 반대 개념이 불명확하면 해당 키워드를 제외하고 다른 키워드만 추출
          3. 절대로 부정한 키워드 자체를 추출하지 마세요

        **부정 표현 변환 예시 (카페):**
        - "시끄러운 곳 싫어" → "조용한", "한적한"
        - "너무 달지 않은" → "덜 단", "적당한 단맛"
        - "쓴 커피 빼고" → "부드러운", "마일드", "고소한"
        - "어두운 곳 말고" → "밝은", "환한"
        - "복잡한 곳 싫어" → "한적한", "여유로운"
        - "작은 곳 싫어" → "넓은", "쾌적한"

        **중요: 분위기 표현의 반대 개념**
        - 시끄럽다 ↔ 조용하다, 한적하다
        - 어둡다 ↔ 밝다, 환하다
        - 복잡하다 ↔ 한적하다, 여유롭다
        - 좁다 ↔ 넓다, 쾌적하다
        - 딱딱하다 ↔ 아늑하다, 편안하다

        이 문장에서 카페 활동과 관련된 핵심 키워드를 정확히 2개 이상 추출해서 쉼표로 구분해서 알려줘.

        **중요: 사용자가 직접 언급한 키워드만 추출하세요.**
        - 사용자가 명시적으로 말한 단어나 그와 직접적으로 연관된 단어만 포함
        - 부정 표현은 위 규칙에 따라 정확한 반대 개념으로 변환
        - 사용자가 언급하지 않은 키워드는 자동으로 추가하지 마세요
        - 예: 사용자가 "힐링, 밤 디저트"라고 했으면 "힐링", "밤 디저트"만 추출하고, "분위기", "휴식" 등은 사용자가 직접 말하지 않았으므로 포함하지 않음

        **카페 관련 키워드 참고 카테고리 (사용자가 직접 언급한 경우에만 추출):**
        1. 메뉴 관련 (아메리카노, 라떼, 카푸치노, 에스프레소, 콜드브루, 차, 디저트, 케이크, 마카롱, 브라우니, 샌드위치, 브런치 등 카페 메뉴 - 사용자가 직접 언급한 경우만)
        2. 분위기 관련 (조용한, 활기찬, 아늑한, 모던한, 밝은, 한적한 등 - 사용자가 직접 언급한 경우만)
        3. 용도 관련 (공부, 업무, 독서, 대화, 휴식 등 - 사용자가 직접 언급한 경우만)
        4. 시설 관련 (와이파이, 콘센트, 넓은 공간, 야외석 등 - 사용자가 직접 언급한 경우만)

        **제외할 키워드:**
        - 감정적 표현 ('좋은', '멋진', '재미있는' 등)
        - 일반적 표현 ('편한', '괜찮은' 등)
        - 서브카테고리 ('한식', '중식', '일식', '양식', '이탈리안', '프렌치', '태국', '베트남' 등 음식 계열 분류)
        - 카테고리명 ('카페', '카페'와 관련된 일반적인 용어) - 이미 카테고리로 설정되어 있으므로 태그로 추출하지 않음
        {people_exclusion_rule}

        다른 설명 없이 키워드만 나열해줘.
        """


def _get_restaurant_prompt(user_detail: str, people_count: int, people_exclusion_rule: str) -> str:
    """
    음식점 카테고리 프롬프트 생성
    """
    return f"""
        [상황 정보]
        - 인원 수: {people_count}명
        - 활동 카테고리: 음식점

        사용자가 "{user_detail}"라고 말했어.

        **0단계: 구어체 표현을 형용사로 정제**
        사용자가 "~거", "~것" 같은 구어체로 입력한 경우, 형용사 형태로 변환하세요:
        
        **맛 관련 구어체 정제:**
        - "매운거" → "매운"
        - "짠거" → "짭짤한"
        - "싱거운거" → "싱거운"
        - "단거" → "달콤한"
        - "쓴거" → "쓴"
        - "신거" → "새콤한"
        - "기름진거" → "기름진"
        - "느끼한거" → "느끼한"
        - "담백한거" → "담백한"
        - "얼큰한거" → "얼큰한"
        - "고소한거" → "고소한"

        **분위기 관련 구어체 정제:**
        - "시끄러운거" → "시끄러운"
        - "조용한거" → "조용한"
        - "넓은거" → "넓은"

        **중요: "~거", "~것" 형태는 절대 그대로 출력하지 마세요**
        - ❌ "매운거" (틀림)
        - ✅ "매운" (정답)

        **절대 규칙: 사용자가 직접 입력한 단어만 추출하세요**
        - 사용자 입력: "닭도리탕" → 출력: "닭도리탕" (고기, 매운, 국물 등 절대 추가 금지)
        - 사용자 입력: "감자탕" → 출력: "감자탕" (얼큰한, 고기, 국물 등 절대 추가 금지)
        - 사용자 입력: "파스타" → 출력: "파스타" (크림, 면, 토마토 등 절대 추가 금지)
        - 사용자 입력: "삼겹살" → 출력: "삼겹살" (돼지고기, 고기, 구이 등 절대 추가 금지)

        **메뉴 이름만 입력된 경우 - 절대 특징을 추론하지 마세요:**
        ❌ 잘못된 예시:
        - "닭도리탕" → "닭도리탕, 고기, 매운, 국물" (틀림)
        - "감자탕" → "감자탕, 얼큰한, 국물, 고기" (틀림)
        
        ✅ 올바른 예시:
        - "닭도리탕" → "닭도리탕" (정답)
        - "감자탕" → "감자탕" (정답)
        - "파스타" → "파스타" (정답)

        **사용자가 명시적으로 특징을 함께 언급한 경우에만 추출 (구어체 정제 적용):**
        - "매운 닭도리탕" → "닭도리탕, 매운"
        - "매운거" → "매운" (구어체 정제)
        - "얼큰한 감자탕" → "감자탕, 얼큰한"
        - "크림 파스타" → "파스타, 크림"
        - "고기 많은 삼겹살" → "삼겹살, 고기"

        **1단계: 부정 표현 확인 및 변환**
        사용자 입력에 다음 부정 표현이 있는지 확인:
        - "~지 않은", "~하지 않은", "안 ~한"
        - "~싫어", "~안돼", "~빼고", "~말고"
        - "~하지 마", "~제외", "~없이"

        **부정 표현 변환 예시 (구어체도 함께 정제):**
        - "짜지 않은거" → "담백한" (부정 변환 + 구어체 정제)
        - "짜지 않은" → "담백한"
        - "짠거 싫어" → "담백한"
        - "매운거 싫어" → "순한", "담백한"
        - "매운거 말고" → "순한"
        - "기름진거 빼고" → "담백한", "깔끔한"
        - "느끼한거 말고" → "산뜻한", "담백한"
        - "싱거운거 싫어" → "짭짤한"
        - "시끄러운 곳 싫어" → "조용한", "한적한"

        **중요: 부정 표현 원문은 절대 추출하지 마세요**
        - ❌ "짜지 않은거" → "짜지 않은거" (틀림)
        - ✅ "짜지 않은거" → "담백한" (정답)

        **2단계: 추출 가능한 키워드 종류**
        다음 중 사용자가 **직접 명시한 것만** 추출 (구어체는 정제 후 추출):
        1. 메뉴 이름 (김치찌개, 파스타, 초밥, 스테이크, 삼겹살, 감자탕, 닭도리탕 등)
        2. 재료 (고기, 야채, 해산물 등) - 사용자가 "고기 많은", "야채 많은" 등으로 직접 언급한 경우만
        3. 맛/특징 (얼큰한, 담백한, 매운, 순한, 짭짤한, 싱거운 등) - 사용자가 직접 언급하거나 부정 표현을 변환한 경우만 (구어체는 정제)
        4. 분위기 (조용한, 한적한 등) - 사용자가 직접 언급한 경우만
        5. 가격대 (저렴한, 고급 등) - 사용자가 직접 언급한 경우만

        **제외할 키워드:**
        - 감정적 표현 ('맛있는', '좋은', '최고' 등)
        - 서브카테고리 ('한식', '중식', '일식', '양식' 등)
        - 카테고리명 ('음식점')
        - **구어체 표현** ("~거", "~것" 형태는 정제 후 출력)
        - **메뉴 이름에서 암묵적으로 연상되는 특징** (예: 닭도리탕→매운, 감자탕→얼큰한 등)
        - 부정 표현 원문 (절대 변환해야 함)
        {people_exclusion_rule}

        **최종 확인:**
        - 구어체 표현("~거", "~것")이 있나요? → 형용사로 정제하여 출력
        - 사용자가 메뉴 이름만 입력했나요? → 메뉴 이름만 출력
        - 사용자가 특징도 함께 언급했나요? → 메뉴 이름 + 정제된 특징 출력
        - 부정 표현이 있나요? → 반대 개념으로 변환하여 출력

        다른 설명 없이 키워드만 쉼표로 구분하여 나열해줘.
        """


def _get_content_prompt(user_detail: str, people_count: int, people_exclusion_rule: str) -> str:
    """
    콘텐츠 카테고리 프롬프트 생성

    Args:
        user_detail: 사용자 입력 문장
        people_count: 인원 수
        people_exclusion_rule: 인원수 관련 제외 규칙

    Returns:
        콘텐츠 카테고리 프롬프트
    """
    return f"""
        [상황 정보]
        - 인원 수: {people_count}명
        - 활동 카테고리: 콘텐츠

        사용자가 "{user_detail}"라고 말했어.

        **부정 표현 처리 규칙:**
        - 사용자가 "~싫어", "~안돼", "~빼고", "~말고" 등 부정 표현을 사용했을 경우:
          1. 명확한 반대 개념이 있으면 반대 키워드로 변환
          2. 반대 개념이 불명확하면 해당 키워드를 제외하고 다른 키워드만 추출
          3. 절대로 부정한 키워드 자체를 추출하지 마세요

        **부정 표현 변환 예시 (콘텐츠):**
        - "무서운 거 싫어" → "잔잔한", "따뜻한", "편안한"
        - "슬픈 영화 말고" → "밝은", "코미디", "유쾌한"
        - "액션 빼고" → "로맨스", "드라마", "힐링"
        - "시끄러운 공연 싫어" → "조용한", "잔잔한", "클래식"
        - "어려운 전시 말고" → "쉬운", "대중적", "친근한"
        - "지루한 거 싫어" → "재미있는", "흥미로운", "활기찬"
        - "자극적인 거 말고" → "잔잔한", "따뜻한", "평화로운"

        **중요: 콘텐츠 분위기/장르의 반대 개념**
        - 무섭다 ↔ 잔잔하다, 따뜻하다, 편안하다
        - 슬프다 ↔ 밝다, 유쾌하다, 즐겁다
        - 지루하다 ↔ 재미있다, 흥미롭다, 활기차다
        - 자극적이다 ↔ 잔잔하다, 평화롭다
        - 어렵다 ↔ 쉽다, 대중적이다
        - 시끄럽다 ↔ 조용하다, 잔잔하다

        **중요: 사용자가 직접 언급한 키워드만 추출하세요.**
        - 사용자가 명시적으로 말한 단어나 그와 직접적으로 연관된 단어만 포함
        - 부정 표현은 위 규칙에 따라 정확한 반대 개념으로 변환
        - 사용자가 언급하지 않은 키워드는 자동으로 추가하지 마세요
        - 예: 사용자가 "영화, 액션"이라고 했으면 "영화", "액션"만 추출하고, "로맨스", "드라마" 등은 사용자가 직접 말하지 않았으므로 포함하지 않음

        이 문장에서 콘텐츠 활동과 관련된 핵심 키워드를 정확히 1개 이상 추출해서 쉼표로 구분해서 알려줘.

        **콘텐츠 관련 키워드 참고 카테고리 (사용자가 직접 언급한 경우에만 추출):**
        1. 활동 종류 (영화, 전시회, 공연, 게임, 쇼핑 등 - 사용자가 직접 언급한 경우만)
        2. 장르 (액션, 로맨스, 코미디, 드라마, 다큐멘터리, 스릴러, 공포 등 - 사용자가 직접 언급한 경우만)
        3. 분위기 (재미있는, 감동적인, 교육적인, 스릴있는, 편안한, 잔잔한 등 - 사용자가 직접 언급한 경우만)
        4. 참여 형태 (커플, 가족, 친구, 그룹 등 - 사용자가 직접 언급한 경우만)
        5. 시간대 (낮, 저녁, 밤, 주말, 평일 등 - 사용자가 직접 언급한 경우만)

        **제외할 키워드:**
        - 감정적 표현 ('좋은', '멋진', '최고' 등)
        - 일반적 표현 ('편한', '괜찮은' 등)
        - 서브카테고리 ('한식', '중식', '일식', '양식' 등 음식 계열 분류는 콘텐츠와 무관)
        {people_exclusion_rule}

        다른 설명 없이 키워드만 나열해줘.
        """


def get_category_prompt(category: str, user_detail: str, people_count: int) -> str:
    """
    카테고리별 맞춤 프롬프트 생성 (라우터 함수)

    Args:
        category: 카테고리명 (카페, 음식점, 콘텐츠)
        user_detail: 사용자 입력 문장
        people_count: 인원 수

    Returns:
        카테고리별 맞춤 프롬프트
    """
    # 인원수 관련 제외 규칙 생성
    people_exclusion_rule = _get_people_exclusion_rule(people_count)

    # 카테고리별 프롬프트 생성 함수 매핑
    prompt_generators = {
        "카페": lambda: _get_cafe_prompt(user_detail, people_count, people_exclusion_rule),
        "음식점": lambda: _get_restaurant_prompt(user_detail, people_count, people_exclusion_rule),
        "콘텐츠": lambda: _get_content_prompt(user_detail, people_count, people_exclusion_rule),
    }

    # 카테고리에 맞는 프롬프트 생성 함수 호출, 없으면 카페 프롬프트 사용
    generator = prompt_generators.get(category, prompt_generators["카페"])
    return generator()


# =============================================================================
# LLM 입력 검증 프롬프트
# =============================================================================
VALIDATION_PROMPT = """
[역할]
당신은 사용자 입력이 {category} 추천을 위한 의미있는 정보인지 판단하는 전문가입니다.

[사용자 입력]
"{user_input}"

[판단 기준]
**중요: 사용자가 {category}와 관련된 선호사항을 표현했다면, 표현이 다소 모호하거나 구어체더라도 의미있는 입력으로 판단하세요.**

의미있는 입력 (다음 중 하나라도 해당):
1. {category}와 직접적으로 관련된 구체적인 선호사항 포함
2. {category}의 분위기, 스타일, 특징을 표현한 경우
3. 형용사나 감성적 표현으로 원하는 느낌을 전달한 경우 (예: "힙한", "모던한", "아늑한", "강렬한" 등)
4. 부정 표현으로 회피하고 싶은 것을 명확히 표현한 경우 (예: "매운거 싫어", "시끄러운 곳 말고", "싱거운거 싫어")

카테고리별 관련 정보 예시:
- 카페: 메뉴(아메리카노, 라떼, 디저트, 케이크 등), 분위기(조용한, 아늑한, 힙한, 모던한, 강렬한 등), 용도(공부, 업무 등), 시설(와이파이, 콘센트 등)
- 음식점: 메뉴(파스타, 삼겹살, 김치찌개 등), 맛/특징(얼큰한, 담백한, 강한, 매운, 순한, 짭짤한, 싱거운 등), 분위기, 가격대
- 콘텐츠: 활동 종류(영화, 전시회, 공연 등), 장르(액션, 로맨스 등), 분위기

의미없는 입력 (다음 중 하나라도 해당되면 무효):
1. **명확한 선택 회피**: "아무거나", "몰라", "상관없어", "그냥"
2. **메타 표현**: "테스트", "없음", "의미없는 단어 나열"
3. **전혀 관련 없는 주제** (예: 카페를 물어봤는데 음식점 메뉴만 나열)
4. **일반적인 인사나 질문** (예: "안녕하세요", "뭐가 있어요?")
5. **구체적인 정보가 전혀 없는 경우** (단, 분위기나 느낌을 표현한 경우는 제외)

**중요**: 표현이 다소 구어체거나 모호하더라도, {category}와 관련된 선호를 표현했다면 "의미있음"으로 판단하세요.

[출력]
다음 중 하나만 출력하세요:
- "의미있음"
- "의미없음"
"""

# =============================================================================
# 챗봇 응답 메시지
# =============================================================================
# 하드코딩된 메시지 템플릿 - 일관된 대화 흐름 유지
RESPONSE_MESSAGES = {
    "start": {
        "first_message": "안녕! 나는 하루야!\n\n{people_count}명이 함께할 거구나! 그리고 {categories_text} 활동을 하고 싶다고 했지?\n\n그럼 먼저 '{first_category}' 활동에 대해 좀 더 자세히 말해줄 수 있어? 어떤 걸 원해?",
        "next_category": "좋아! 그럼 '{next_category}' 활동은 어떤 걸 원해?",
        "all_completed": "모든 활동에 대한 질문이 끝났어!",
        "add_more": "좋아! '{current_category}' 활동에 대해 더 추가하고 싶은 내용이 있어?",
        "final_result": "짜잔! 오늘의 추천 리스트야! 이 중에서 마음에 드는 게 있으면 좋겠다! 즐거운 하루 보내!",
        "modification_mode": "어떤 내용을 수정할래? 선택한 활동 중 더 추가하고 싶은 게 있어?",
        "unclear_response": "미안해! '다음 질문' 또는 '추가하기'로 답변해줘.",
        "unclear_result_response": "미안해! '후보지 출력' 버튼을 눌러줘."
    },
    "buttons": {
        "yes_no_question": "이 정보로 다음 질문으로 넘어갈래?",
        "result_question": "후보지를 출력할래?"
    },
    "random": {
        "ask": "혹시 아무거나 괜찮다면 랜덤으로 추천해줄 수도 있어. 랜덤 추천을 받아볼까?",
        "ask_question": "랜덤하게 추천을 받아볼래?",
        "ready": "좋아! 랜덤 추천을 준비해둘게.",
        "decline": "알겠어! 그럼 원하는 걸 조금 더 알려줄 수 있을까?",
        "summary_tag": "랜덤 추천"
    },
    "validation": {
        "too_short": "좀 더 구체적으로 말해줘!!",
        "only_special_chars": "의미있는 단어로 말해줘!!",
        "keyboard_pattern": "구체적인 선호사항을 알려줘!!",
        "repetitive": "어떤 걸 원하는지 구체적으로 말해줘!!",
        "only_numbers": "어떤 종류의 장소를 원하는지 말해줘!!",
        "ambiguous": "좀 더 명확하게 설명해줄래?",
        "too_long": "입력이 너무 길어. 간단하게 요약해서 말해줘!!"
    }
}