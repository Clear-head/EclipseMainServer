<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 관리</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar__brand">오늘 뭐하지?</div>
            <nav class="sidebar__nav" aria-label="사이드바">
                <a class="sidebar__tab" href="dashboard.html">통계 관리</a>
                <a class="sidebar__tab" href="data.html">데이터 관리</a>
                <a class="sidebar__tab is-active" href="users.html">사용자 관리</a>
            </nav>
        </aside>
        <div class="content">
            <header>
                <h1>사용자 관리</h1>
            </header>
            <main class="users-main">
                <section class="summary-card users-card-wide">
                    <h2>신고 현황</h2>
                    <div class="card__body">
                        <div class="chart-row" style="margin-top: 18px; margin-bottom: 32px; align-items: flex-start; gap: 24px;">
                            <div class="chart-row__media">
                                <canvas id="accountStatusPie" aria-label="계정 상태 분포"></canvas>
                            </div>
                            <div class="chart-row__legend" id="accountStatusLegend" style="justify-content: flex-start;">
                                <!-- 동적으로 생성됩니다 -->
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>사용자</th>
                                    <th>계정 상태</th>
                                    <th>최근 신고</th>
                                    <th>최근 신고 횟수</th>
                                    <th>조치</th>
                                </tr>
                            </thead>
                            <tbody id="accountAndReportStatusBody">
                                <!-- 동적으로 생성됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="summary-card users-card-wide">
                    <h2>계정 삭제 이유</h2>
                    <div class="chart-row" style="margin-top: 18px;">
                        <div class="chart-row__media">
                            <canvas id="accountReasonPie" aria-label="계정 삭제 이유 분포"></canvas>
                        </div>
                        <div class="chart-row__legend" id="deleteCauseLegend">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                    </div>
                </section>

                <section class="summary-card users-card-full">
                    <h2>사용자 문의 및 신고 사항</h2>
                    <div class="card__body">
                        <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px; color: #52606d; font-weight: 600;">일반 문의 사항</h3>
                        <table style="margin-bottom: 32px;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>사용자</th>
                                    <th>문의 내용</th>
                                    <th>날짜</th>
                                    <th>처리 여부</th>
                                </tr>
                            </thead>
                            <tbody id="generalInquiriesBody">
                                <!-- 동적으로 생성됩니다 -->
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 16px;">
                            <button type="button" onclick="showMoreInquiries(this)" style="padding: 8px 16px; font-size: 14px;">더보기</button>
                        </div>
                        
                        <h3 style="margin-top: 24px; margin-bottom: 16px; font-size: 16px; color: #52606d; font-weight: 600;">신고 문의 사항</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>신고자</th>
                                    <th>타입</th>
                                    <th>신고 유형</th>
                                    <th>신고 사유</th>
                                    <th>날짜</th>
                                    <th>처리 여부</th>
                                </tr>
                            </thead>
                            <tbody id="reportInquiriesBody">
                                <!-- 동적으로 생성됩니다 -->
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 16px;">
                            <button type="button" onclick="showMoreReports(this)" style="padding: 8px 16px; font-size: 14px;">더보기</button>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    const reasonPalette = ['#FF6F00', '#FF9800', '#FFB74D', '#FFCC80'];

    if (window.ChartDataLabels) {
        Chart.register(window.ChartDataLabels);
    }

    function createPieChart(canvasId, labels, data, colors) {
        const canvas = document.getElementById(canvasId);

        if (!canvas) {
            return;
        }

        const chart = new Chart(canvas, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data: data.map(() => 0),
                    backgroundColor: labels.map((_, idx) => colors[idx % colors.length]),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1200,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    datalabels: {
                        formatter(value, context) {
                            const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                            if (!total) return '';
                            const percent = ((value / total) * 100).toFixed(0);
                            return `${percent}%`;
                        },
                        color: '#ffffff',
                        font: {
                            weight: 'bold',
                            size: 14
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${value} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });

        setTimeout(() => {
            chart.data.datasets[0].data = data;
            chart.update();
        }, 120);

        return chart;
    }

    // 계정 삭제 이유 통계 조회 및 차트 업데이트
    let accountReasonChart = null;
    async function loadDeleteCauseStats() {
        try {
            const response = await fetch('/api/dashboard/delete-cause-stats');
            const data = await response.json();
            
            if (!data || data.length === 0) {
                console.warn('계정 삭제 이유 데이터가 없습니다.');
                return;
            }
            
            const labels = data.map(item => item.cause);
            const counts = data.map(item => item.count);
            const total = counts.reduce((sum, val) => sum + val, 0);
            
            // 범례 업데이트
            const legendEl = document.getElementById('deleteCauseLegend');
            if (legendEl) {
                legendEl.innerHTML = data.map((item, index) => {
                    const color = reasonPalette[index % reasonPalette.length];
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                    return `<div class="chart-row__legend-item">
                        <span class="chart-row__swatch" style="background-color: ${color};"></span>
                        ${item.cause} · ${item.count}건 (${percentage}%)
                    </div>`;
                }).join('');
            }
            
            // 차트 업데이트
            if (accountReasonChart) {
                accountReasonChart.data.labels = labels;
                accountReasonChart.data.datasets[0].data = counts;
                accountReasonChart.data.datasets[0].backgroundColor = labels.map((_, idx) => reasonPalette[idx % reasonPalette.length]);
                accountReasonChart.update();
            } else {
                // 차트가 없으면 생성
                accountReasonChart = createPieChart(
                    'accountReasonPie',
                    labels,
                    counts,
                    reasonPalette
                );
            }
        } catch (error) {
            console.error('계정 삭제 이유 통계 조회 오류:', error);
        }
    }
    
    // 페이지 로드 시 계정 삭제 이유 통계 조회
    loadDeleteCauseStats();

    // 계정 상태 파이차트 변수
    let accountStatusChart = null;
    const statusPalette = ['#4CAF50', '#FF9800'];


    // 일반 문의 사항 데이터 로드 및 테이블 렌더링
    let generalInquiriesData = [];
    async function loadGeneralInquiries() {
        try {
            const response = await fetch('/api/dashboard/general-inquiries');
            const data = await response.json();
            generalInquiriesData = data;
            
            const tbody = document.getElementById('generalInquiriesBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">데이터가 없습니다.</td></tr>';
                return;
            }
            
            // 처음 4개만 표시, 나머지는 숨김
            const visibleCount = 4;
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                if (index >= visibleCount) {
                    row.className = 'inquiry-hidden';
                    row.style.display = 'none';
                }
                
                const causeText = item.cause || '';
                const shortCause = causeText.length > 30 ? causeText.substring(0, 30) + '...' : causeText;
                
                row.innerHTML = `
                    <td>${item.id || ''}</td>
                    <td>${item.reporter || ''}</td>
                    <td>${shortCause} <button type="button" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;" onclick="showFullInquiry(this)">더보기</button></td>
                    <td>${item.reported_at || ''}</td>
                    <td class="status-cell" data-is-processed="${item.is_processed || 0}">${item.is_processed === 1 ? '완료' : '미완료'}</td>
                `;
                tbody.appendChild(row);
            });
            
            // 더보기 버튼 표시 여부
            const moreButton = document.querySelector('button[onclick="showMoreInquiries(this)"]');
            if (moreButton && data.length <= visibleCount) {
                moreButton.style.display = 'none';
            } else if (moreButton) {
                moreButton.style.display = 'inline-block';
                moreButton.textContent = '더보기';
            }
            
            updateStatusCells();
        } catch (error) {
            console.error('일반 문의 사항 조회 오류:', error);
            const tbody = document.getElementById('generalInquiriesBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #F44336;">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
            }
        }
    }

    // 신고 문의 사항 데이터 로드 및 테이블 렌더링
    let reportInquiriesData = [];
    async function loadReportInquiries() {
        try {
            const response = await fetch('/api/dashboard/report-inquiries');
            const data = await response.json();
            reportInquiriesData = data;
            
            const tbody = document.getElementById('reportInquiriesBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">데이터가 없습니다.</td></tr>';
                return;
            }
            
            // 처음 5개만 표시, 나머지는 숨김
            const visibleCount = 5;
            data.forEach((item, index) => {
                const row = document.createElement('tr');
                if (index >= visibleCount) {
                    row.className = 'report-hidden';
                    row.style.display = 'none';
                }
                
                const causeText = item.cause || '';
                const shortCause = causeText.length > 20 ? causeText.substring(0, 20) + '...' : causeText;
                const showMoreButton = causeText.length > 20 ? `<button type="button" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;" onclick="showFullReason(this)">더보기</button>` : '';
                
                row.innerHTML = `
                    <td>${item.id || ''}</td>
                    <td>${item.reporter || ''}</td>
                    <td>${item.type_name || ''}</td>
                    <td>${item.cause || ''}</td>
                    <td>${shortCause}${showMoreButton}</td>
                    <td>${item.reported_at || ''}</td>
                    <td class="status-cell" data-is-processed="${item.is_processed || 0}">${item.is_processed === 1 ? '완료' : '미완료'}</td>
                `;
                tbody.appendChild(row);
            });
            
            // 더보기 버튼 표시 여부
            const moreButton = document.querySelector('button[onclick="showMoreReports(this)"]');
            if (moreButton && data.length <= visibleCount) {
                moreButton.style.display = 'none';
            } else if (moreButton) {
                moreButton.style.display = 'inline-block';
                moreButton.textContent = '더보기';
            }
            
            updateStatusCells();
        } catch (error) {
            console.error('신고 문의 사항 조회 오류:', error);
            const tbody = document.getElementById('reportInquiriesBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #F44336;">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
            }
        }
    }

    function showFullInquiry(button) {
        const row = button.closest('tr');
        const reporter = row.querySelector('td:nth-child(2)').textContent.trim();
        const fullCause = generalInquiriesData.find(item => item.reporter === reporter)?.cause || '상세 내용을 확인할 수 없습니다.';
        
        alert(`[${reporter}] 문의 내용\n\n${fullCause}`);
    }

    function showFullReason(button) {
        const row = button.closest('tr');
        const reporter = row.querySelector('td:nth-child(2)').textContent.trim();
        const fullCause = reportInquiriesData.find(item => item.reporter === reporter)?.cause || '상세 내용을 확인할 수 없습니다.';
        
        alert(`[${reporter}] 신고 사유\n\n${fullCause}`);
    }

    function showMoreInquiries(button) {
        const hiddenRows = document.querySelectorAll('.inquiry-hidden');
        
        if (button.textContent === '더보기') {
            hiddenRows.forEach(row => {
                row.style.display = '';
            });
            button.textContent = '닫기';
        } else {
            hiddenRows.forEach(row => {
                row.style.display = 'none';
            });
            button.textContent = '더보기';
        }
    }

    function showMoreReports(button) {
        const hiddenRows = document.querySelectorAll('.report-hidden');
        
        if (button.textContent === '더보기') {
            hiddenRows.forEach(row => {
                row.style.display = '';
            });
            button.textContent = '닫기';
        } else {
            hiddenRows.forEach(row => {
                row.style.display = 'none';
            });
            button.textContent = '더보기';
        }
    }

    // 처리 여부 표시 함수 (is_processed 값에 따라 자동으로 표시)
    function updateStatusCells() {
        document.querySelectorAll('.status-cell').forEach(cell => {
            const isProcessed = parseInt(cell.getAttribute('data-is-processed'));
            if (isProcessed === 1) {
                cell.textContent = '완료';
                cell.style.color = '#4CAF50';
                cell.style.fontWeight = '600';
            } else {
                cell.textContent = '미완료';
                cell.style.color = '#F44336';
                cell.style.fontWeight = '600';
            }
        });
    }

    // 계정 및 신고 현황 데이터 로드 및 테이블 렌더링
    async function loadAccountAndReportStatus() {
        try {
            const response = await fetch('/api/dashboard/account-and-report-status');
            const data = await response.json();
            
            const tbody = document.getElementById('accountAndReportStatusBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">데이터가 없습니다.</td></tr>';
                // 파이차트 업데이트 (데이터 없음)
                updateAccountStatusChart({});
                return;
            }
            
            // 계정 상태 집계
            const statusCounts = {
                '활성': 0,
                '비활성': 0
            };
            
            data.forEach((item) => {
                const status = item.account_status || '활성';
                if (statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                } else {
                    statusCounts[status] = 1;
                }
            });
            
            // 파이차트 업데이트
            updateAccountStatusChart(statusCounts);
            
            data.forEach((item) => {
                const row = document.createElement('tr');
                
                // 사용자 ID 셀
                const userIdCell = document.createElement('td');
                userIdCell.textContent = item.user_id || '';
                
                // 계정 상태 셀
                const statusCell = document.createElement('td');
                statusCell.textContent = item.account_status || '활성';
                if (item.account_status === '비활성') {
                    statusCell.style.color = '#FF9800';
                    statusCell.style.fontWeight = '600';
                } else {
                    statusCell.style.color = '#4CAF50';
                    statusCell.style.fontWeight = '600';
                }
                
                // 최근 신고 셀 (3개까지만 표시, 더보기/접기 버튼)
                const reportsCell = document.createElement('td');
                const reportsText = item.recent_reports && item.recent_reports !== '없음' 
                    ? item.recent_reports 
                    : '없음';
                
                if (reportsText !== '없음') {
                    const reportsArray = reportsText.split(', ').map(r => r.trim()).filter(r => r);
                    const hasMoreReports = reportsArray.length > 3;
                    const displayReports = hasMoreReports ? reportsArray.slice(0, 3) : reportsArray;
                    const hiddenReports = hasMoreReports ? reportsArray.slice(3) : [];
                    
                    const reportsContainer = document.createElement('div');
                    reportsContainer.style.display = 'flex';
                    reportsContainer.style.flexWrap = 'wrap';
                    reportsContainer.style.gap = '4px';
                    reportsContainer.style.alignItems = 'center';
                    
                    const visibleSpan = document.createElement('span');
                    visibleSpan.textContent = displayReports.join(', ');
                    
                    const hiddenSpan = document.createElement('span');
                    hiddenSpan.className = 'hidden-reports';
                    hiddenSpan.style.display = 'none';
                    hiddenSpan.textContent = hiddenReports.length > 0 ? ', ' + hiddenReports.join(', ') : '';
                    
                    const toggleButton = document.createElement('button');
                    toggleButton.type = 'button';
                    toggleButton.textContent = '더보기';
                    toggleButton.style.display = hasMoreReports ? 'inline-block' : 'none';
                    toggleButton.style.marginLeft = '8px';
                    toggleButton.style.padding = '2px 8px';
                    toggleButton.style.fontSize = '12px';
                    toggleButton.style.color = '#FF8126';
                    toggleButton.style.backgroundColor = 'transparent';
                    toggleButton.style.border = '1px solid #FF8126';
                    toggleButton.style.borderRadius = '4px';
                    toggleButton.style.cursor = 'pointer';
                    toggleButton.style.transition = 'all 0.2s ease';
                    toggleButton.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#FF8126';
                        this.style.color = '#ffffff';
                    });
                    toggleButton.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'transparent';
                        this.style.color = '#FF8126';
                    });
                    toggleButton.addEventListener('click', function() {
                        const isExpanded = hiddenSpan.style.display !== 'none';
                        if (isExpanded) {
                            hiddenSpan.style.display = 'none';
                            toggleButton.textContent = '더보기';
                        } else {
                            hiddenSpan.style.display = 'inline';
                            toggleButton.textContent = '접기';
                        }
                    });
                    
                    reportsContainer.appendChild(visibleSpan);
                    reportsContainer.appendChild(hiddenSpan);
                    reportsContainer.appendChild(toggleButton);
                    reportsCell.appendChild(reportsContainer);
                } else {
                    reportsCell.textContent = '없음';
                }
                
                // 최근 신고 횟수 셀
                const reportCountCell = document.createElement('td');
                reportCountCell.textContent = item.report_count || 0;
                reportCountCell.style.textAlign = 'center';
                
                // 조치 셀 (비활성화 버튼)
                const actionCell = document.createElement('td');
                const deactivateButton = document.createElement('button');
                deactivateButton.type = 'button';
                deactivateButton.textContent = '비활성화';
                deactivateButton.style.padding = '4px 12px';
                deactivateButton.style.fontSize = '12px';
                deactivateButton.style.color = '#ffffff';
                deactivateButton.style.backgroundColor = '#F44336';
                deactivateButton.style.border = 'none';
                deactivateButton.style.borderRadius = '4px';
                deactivateButton.style.cursor = 'pointer';
                deactivateButton.style.transition = 'all 0.2s ease';
                deactivateButton.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#D32F2F';
                });
                deactivateButton.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#F44336';
                });
                // 기능은 아직 추가하지 않음
                actionCell.appendChild(deactivateButton);
                
                row.appendChild(userIdCell);
                row.appendChild(statusCell);
                row.appendChild(reportsCell);
                row.appendChild(reportCountCell);
                row.appendChild(actionCell);
                
                tbody.appendChild(row);
            });
        } catch (error) {
            console.error('계정 및 신고 현황 조회 오류:', error);
            const tbody = document.getElementById('accountAndReportStatusBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #F44336;">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
            }
        }
    }

    // 계정 상태 파이차트 업데이트 함수
    function updateAccountStatusChart(statusCounts) {
        const labels = ['활성', '비활성'];
        const counts = [
            statusCounts['활성'] || 0,
            statusCounts['비활성'] || 0
        ];
        const total = counts.reduce((sum, val) => sum + val, 0);
        
        // 범례 업데이트
        const legendEl = document.getElementById('accountStatusLegend');
        if (legendEl) {
            if (total === 0) {
                legendEl.innerHTML = '<div class="chart-row__legend-item">데이터가 없습니다.</div>';
            } else {
                legendEl.innerHTML = labels.map((label, index) => {
                    const color = statusPalette[index % statusPalette.length];
                    const count = counts[index];
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    return `<div class="chart-row__legend-item">
                        <span class="chart-row__swatch" style="background-color: ${color};"></span>
                        ${label}: ${count.toLocaleString()} (${percentage}%)
                    </div>`;
                }).join('');
            }
        }
        
        // 차트 업데이트
        if (accountStatusChart) {
            accountStatusChart.data.labels = labels;
            accountStatusChart.data.datasets[0].data = counts;
            accountStatusChart.data.datasets[0].backgroundColor = labels.map((_, idx) => statusPalette[idx % statusPalette.length]);
            accountStatusChart.update();
        } else {
            // 차트가 없으면 생성
            accountStatusChart = createPieChart(
                'accountStatusPie',
                labels,
                counts,
                statusPalette
            );
        }
    }

    // 페이지 로드 시 실행
    updateStatusCells();
    loadGeneralInquiries();
    loadReportInquiries();
    loadAccountAndReportStatus();
</script>
</html>

